
filter {
  if [garage] {
    mutate { replace => { type => "parking-api-v1" } }

    if [location][type] == "point" {
      # Everybody gets caught at least once: string geo-points are "latitude,longitude", while array geo-points are [longitude,latitude]—the opposite order!
      mutate { add_field => { geo_point => "%{location[coordinates][1]}, %{location[coordinates][0]}" } }
    }
  }

  if [@type] == "Event" {

    if ([location][geo][latitude]) {
      # Everybody gets caught at least once: string geo-points are "latitude,longitude", while array geo-points are [longitude,latitude]—the opposite order!
      mutate { add_field => { geo_point => "%{[location][geo][latitude]}, %{[location][geo][longitude]}" } }
    }

    if ([location][address][streetAddress]) {
      mutate { add_field => { geocoder_address => "%{[location][address][streetAddress]}, %{[location][address][postalCode]}, %{[location][address][addressLocality]}" } }

      geocoder {
        # source => "%{[location][address]}"
        # (works) source => "[location][address]"
        # source => "%{[location][address][streetAddress]}"
        # source => "[location][address][streetAddress]"
        source => "[geocoder_address]"
        target => "[geo_point_geocoder]"
        lookup => "yandex"
        cache_size => 100
      }

      mutate { add_field => { geo_point_geocoder_reverse => "%{[geo_point_geocoder][0]}, %{[geo_point_geocoder][1]}" } }

    }
  }
}
